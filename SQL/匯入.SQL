DROP TABLE IF EXISTS P2_ITEM_FEATURE_CJ;
CREATE TABLE P2_ITEM_FEATURE_CJ AS
SELECT * FROM TIANCHI_DATA.P2_ITEM_FEATURE;

DROP TABLE IF EXISTS P2_ITEM_STORE_FEATURE_CJ;
CREATE TABLE P2_ITEM_STORE_FEATURE_CJ AS
SELECT * FROM TIANCHI_DATA.P2_ITEM_STORE_FEATURE;

DROP TABLE IF EXISTS P2_CONFIG_CJ;
CREATE TABLE P2_CONFIG_CJ AS
SELECT
	ITEM_ID
	, STORE_CODE
	, CAST(SPLIT_PART(CONFIG, '_', 1) AS DOUBLE) AS A
	, CAST(SPLIT_PART(CONFIG, '_', 2) AS DOUBLE) AS B
FROM TIANCHI_DATA.P2_CONFIG;

DROP TABLE IF EXISTS IF_CJ;
CREATE TABLE IF_CJ AS
SELECT
	THEDATE
	, DASE
	, R.ITEM_ID
	, R.SUPPLIER_ID
	, R.STORE_CODE
	, QAN
	, A
	, B
FROM
(
	SELECT
		THEDATE
		, DATEDIFF(TO_DATE("20151228", "YYYYMMDD"), TO_DATE(CAST(THEDATE AS STRING), "YYYYMMDD"), "DD") AS DASE
		, ITEM_ID
		, SUPPLIER_ID
		, "all" AS STORE_CODE
		, CAST(QTY_ALIPAY_NJHS AS DOUBLE) AS QAN
	FROM P2_ITEM_FEATURE_CJ
	UNION ALL
	SELECT
		THEDATE
		, DATEDIFF(TO_DATE("20151228", "YYYYMMDD"), TO_DATE(CAST(THEDATE AS STRING), "YYYYMMDD"), "DD") AS DASE
		, ITEM_ID
		, SUPPLIER_ID
		, CAST(STORE_CODE AS STRING) AS STORE_CODE
		, CAST(QTY_ALIPAY_NJHS AS DOUBLE) AS QAN
	FROM P2_ITEM_STORE_FEATURE_CJ
)R
LEFT OUTER JOIN P2_CONFIG_CJ
ON R.ITEM_ID == P2_CONFIG_CJ.ITEM_ID AND R.STORE_CODE == P2_CONFIG_CJ.STORE_CODE;

DROP TABLE IF EXISTS IF_IAF_CJ;
CREATE TABLE IF_IAF_CJ AS
SELECT 
	R.THEDATE, R.DASE, P2_CONFIG_CJ.ITEM_ID, P2_CONFIG_CJ.STORE_CODE, IMAD, CASE WHEN ISNULL(QAN) THEN 0 ELSE QAN END AS QAN, QANALL, DSQAN, P2_CONFIG_CJ.A, P2_CONFIG_CJ.B
FROM 
P2_CONFIG_CJ
LEFT OUTER JOIN 
(
	SELECT THEDATE, DASE, ITEM_ID, QAN AS QANALL
	FROM IF_CJ
	WHERE STORE_CODE == "all"
)R
ON P2_CONFIG_CJ.ITEM_ID == R.ITEM_ID
LEFT OUTER JOIN 
(
	SELECT ITEM_ID, MAX(DASE) AS IMAD
	FROM IF_CJ
	GROUP BY ITEM_ID
)S
ON P2_CONFIG_CJ.ITEM_ID == S.ITEM_ID
LEFT OUTER JOIN IF_CJ
ON P2_CONFIG_CJ.ITEM_ID == IF_CJ.ITEM_ID AND P2_CONFIG_CJ.STORE_CODE == IF_CJ.STORE_CODE AND R.DASE == IF_CJ.DASE
LEFT OUTER JOIN
(
	SELECT DASE, SUM(QAN) AS DSQAN
	FROM IF_CJ
	WHERE STORE_CODE == "all"
	GROUP BY DASE
)T
ON R.DASE == T.DASE;
